<!DOCTYPE html>
<!------------------------------------------------------------------------------
| Copyright (C) 2012-2013 Leap Motion, Inc. All rights reserved.               |
| Leap Motion proprietary and confidential. Not for distribution.              |
| Use subject to the terms of the Leap Motion SDK Agreement available at       |
| https://developer.leapmotion.com/sdk_agreement, or another agreement         |
| between Leap Motion and you, your company or other organization.             |
------------------------------------------------------------------------------->
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Leap JavaScript Sample</title>
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" type="text/css"/>

        <style>
            body {
                overflow-y:scroll;
                overflow-x:hidden;
            }
        </style>
        <script src="http://code.jquery.com/jquery-2.0.0.min.js"></script>
        <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>

        <script src="leap.js"></script>
        <script>
            $(document).ready(function() {

                getDPI();
                //jquery-ui stuff
                $("#test-button").click(function(event) {
                    paused = !paused;
                    console.log("paused: " + paused);
                });

                $("#test-button").css("background-color", "yellow");
                $("#test-button").mouseover(function(eventData) {
                    $("#test-button").css("background-color", "green");
                });

                $("#test-button").mouseout(function(eventData) {
                    $("#test-button").css("background-color", "yellow");
                });

                $("#test-button").css("height", "400");
                $("#test-button").css("width", "400");
                $("#test-button").css("border-radius", "25px");

                //handle leap stuff
                $("#cursor").css("position", "absolute");
                $("#cursor").css("opacity", "0.4");
                $("#cursor").css("z-index", 100);
                // Store frame for motion functions
                var previousFrame;
                var paused = false;
                var pauseOnGesture = false;
                var frames = 0;
                var elementsFromLastFrame = new Array();
                // Setup Leap loop with frame callback function
                var controllerOptions = {enableGestures: true};

                Leap.loop(controllerOptions, function(frame) {
                    if (paused) {
                        return; // Skip this update
                    }
                    frames += 1;
                    //console.log("FRAMES: "+frames);

                    // Frame motion factors
                    if (previousFrame) {

                    }

                    // Display Hand object data
                    if (frame.hands.length > 0) {
                        handlePointables(frame);
                        for (var i = 0; i < frame.hands.length; i++) {
                            var hand = frame.hands[i];

                            // Hand motion factors
                            if (previousFrame) {

                            }

                            // IDs of pointables (fingers and tools) associated with this hand
                            if (hand.pointables.length > 0) {

                                for (var j = 0; j < hand.pointables.length; j++) {
                                    var pointable = hand.pointables[j];
                                    if (pointable.tool) {

                                    }
                                    else {

                                    }
                                }

                            }
                        }
                    }
                    else {

                    }

                    // Display Pointable (finger and tool) object data
                    if (frame.pointables.length > 0) {
                        // console.log("# OF POINTABLES: "+frame.pointables.length);
//                        handlePointables(frame);
                    }
                    else {

                    }


                    // Display Gesture object data
                    if (frame.gestures.length > 0) {
                        if (pauseOnGesture) {
                            togglePause();
                        }
                        for (var i = 0; i < frame.gestures.length; i++) {
                            var gesture = frame.gestures[i];


                            switch (gesture.type) {
                                case "circle":

                                    break;
                                case "swipe":

                                    break;
                                case "screenTap":
                                    handleScreenTap(gesture);
                                    break;

                                case "keyTap":

                                    break;
                                default:

                            }

                        }
                    }
                    else {

                    }

                    // Store frame for motion functions
                    previousFrame = frame;
                })

                function contains(container, value) {
                    if (container.indexOf(value) === -1) {
                        return false;
                    } else {
                        return true;
                    }
                }

                function elementsWeJustExited(freshElements) {
                    var output = new Array();
                    //get elements in last frame that are no longer in this frame

                    for (var i in elementsFromLastFrame) {
                        var oldElement = elementsFromLastFrame[i];


                        //if old element is no longer in our current list of elements
                        //add it to be exited.
                        if (!contains(freshElements, oldElement)) {
                            output.push(elementsFromLastFrame[i]);
                        }
                    }

                    return output;
                }

                function elementsWeJustEntered(elements) {
                    var output = new Array();

                    for (var i in elements) {
                        var newElement = elements[i];
                        //if new element wasn't in here previously...
                        if (!contains(elementsFromLastFrame, newElement)) {
                            output.push(newElement);
                        }
                    }
                }

                function elementFromPick(x, y) {
                    return document.elementFromPoint(x, y);
                }

                var previousElement = document;
                function handlePointables(frame) {

                    if (frame.hands.length <= 0) {
                        return;
                    }
                    var pointable = frame.hands[0];
                    var vecPosition = pointable.palmPosition;
                    console.log("POSITION: "+vecPosition);

                    var xPos = getNewXPosition(vecPosition);
                    var yPos = getNewYPosition(vecPosition);

                    var element = elementFromPick(MMToPixels(xPos), MMToPixels(yPos));

                    if (element !== previousElement) {
                        $(previousElement).mouseout();
                        $(element).mouseenter();
                        previousElement = element;
                    }

                    $("#cursor").css("left", MMToPixels(xPos));
                    $("#cursor").css("top", MMToPixels(yPos));

                    $("#position").text("(" + Math.ceil(MMToPixels(xPos)) + "," + Math.ceil(MMToPixels(yPos)) + ")");

                    for (var i = 0; i < frame.pointables.length; i++) {
                        var pointable = frame.pointables[i];

                        if (pointable.tool) {

                        }
                        else {

                        }
                    }
                }

                function handleScreenTap(gesture) {
                    var x = getNewXPosition(gesture.position);
                    var y = getNewYPosition(gesture.position);
                    x = MMToPixels(x);
                    y = MMToPixels(y);
                    console.log("CLICKING: (" + x + "," + y + ")");
                    console.log($("#test-button").position());
                    $(document.elementFromPoint(x, y)).click();

                }

                function vectorToString(vector, digits) {
                    if (typeof digits === "undefined") {
                        digits = 1;
                    }
                    return "(" + vector[0].toFixed(digits) + ", "
                            + vector[1].toFixed(digits) + ", "
                            + vector[2].toFixed(digits) + ")";
                }

                function togglePause() {
                    paused = !paused;
                }

                function pauseForGestures() {

                }

            });

            function getMaxMagnitude(heightInMM) {
                return Math.abs(heightInMM * Math.tan(75));
            }

            function getNewXPosition(vector) {
                var x = vector[0]; //in mm
                var y = vector[1]; //in mm
//                console.log("RAW POSITION(mm): ("+x+","+y+")")

                var screenHeightInPixels = $("body").height();
                var screenWidthInPixels = $("body").width();
//                console.log("SCREEN DIMENSIONS (pixels): ("+screenWidthInPixels+","+screenHeightInPixels+")");

                var dpi_X = dpiX();
                var dpi_Y = dpiY();

//                console.log("DOTS PER INCH (pixels): ("+dpi_X+","+dpi_Y+")");
                var screenHeightInMM = inchesToMM(screenHeightInPixels / dpi_Y);
                var screenWidthInMM = inchesToMM(screenWidthInPixels / dpi_X);

//                console.log("SCREEN DIMENSIONS (mm): ("+screenWidthInMM+","+screenHeightInMM+")");

                var halfLeapWidth = getMaxMagnitude(y);
//                console.log("MAX DOMAIN (mm): ["+halfLeapWidth*-1+","+halfLeapWidth+"]");

                var multiplier = ((x + halfLeapWidth) / (halfLeapWidth * 2));

//                console.log("MULTIPLIER: "+multiplier) * 0.05;

                return Clamp(0, screenWidthInMM, multiplier * screenWidthInMM);
//                var val =  Math.max(0, multiplier * screenWidthInMM);
//                if(val >= screenWidthInPixels) {
//                    return screenWidthInPixels;
//                } else {
//                    return val;
//                }


            }

            function getNewYPosition(vector) {
                var y = vector[1]; //in mm
                var screenHeightInPixels = $(document).height();

                var dpi_Y = dpiY();//pixels per inch.

                //(height in pixels * 1inch/96 pixels) inches * (25.4 mm/ 1 inch)
                var screenHeightInMM = inchesToMM(screenHeightInPixels / dpi_Y);


                // #mms/600mms
                var multiplier = y / 600;

                //final value in MM
                var finalY = (screenHeightInMM) - (multiplier * screenHeightInMM);

                //return the value between the two bounds, otherwise return the closest bound
                return Clamp(0, screenHeightInMM, finalY);
            }

            function checkLibrary() {
                if (typeof Leap === "undefined") {
                    document.getElementById("main").innerHTML = "The Leap JavaScript client library (leap.js file) was not found. Please download the library from the GitHub project at <a href='https://github.com/leapmotion/leapjs'>https://github.com/leapmotion/leapjs</a>."
                    alert("The Leap JavaScript client library (leap.js file) was not found. Please download the latest version from the GitHub project at https://github.com/leapmotion/leapjs");
                }
            }

            function getDPI() {
                dpi_X = document.getElementById('testdiv').offsetWidth;
                console.log("X pixels per inch: " + dpi_X);
                dpi_Y = document.getElementById('testdiv').offsetHeight;
                console.log("Y pixels per inch: " + dpi_Y);
            }

            function dpiX() {
                //in inches
                return document.getElementById('testdiv').offsetWidth;
            }

            function dpiY() {
                //in inches
                return document.getElementById('testdiv').offsetHeight;
            }

            function inchesToMM(value) {
                return value * 25.4;
            }

            function MMToPixels(valueInMM) {
                var MMPerInch = 25.4;

                return (valueInMM / MMPerInch) * dpiX();
            }

            function Clamp(lowerBound, upperBound, value) {
                var out = Math.max(lowerBound, value);
                if (out >= upperBound) {
                    return upperBound;
                } else {
                    return out;
                }

            }
        </script>
    </head>
    <body onload="checkLibrary()">
        <h1>Leap JavaScript Sample</h1>
        <div id="main">
            <h5 id="position"> X:</h5>
            <img id="cursor" src="http://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Ski_trail_rating_symbol-green_circle.svg/64px-Ski_trail_rating_symbol-green_circle.svg.png" />
        </div>
        <br/><br/><br/><br/><br/><br/>
        <div id="jquery-ui-testing">
            <center>
                <div id="test-button">TEST!</div>
            </center>
        </div>


        <!-- testdiv for finding our DPI -->
        <div id='testdiv' style='height: 1in; left: -100%; position: absolute; top: -100%; width: 1in;'></div>

    </body>
</html>
